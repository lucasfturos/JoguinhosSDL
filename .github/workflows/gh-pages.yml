name: Build and Deploy SDL Games (gh-pages)

on:
    push:
        branches:
            - main

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install system dependencies
              run: |
                  sudo apt update
                  sudo apt install -y cmake python3 git

            # -------- Cache Emscripten --------
            - name: Cache Emscripten SDK
              uses: actions/cache@v3
              with:
                  path: emsdk
                  key: emscripten-${{ runner.os }}-latest
                  restore-keys: |
                      emscripten-${{ runner.os }}-

            - name: Install Emscripten
              run: |
                  if [ ! -d "emsdk" ]; then
                    git clone https://github.com/emscripten-core/emsdk.git
                  fi
                  cd emsdk
                  ./emsdk install latest
                  ./emsdk activate latest
                  echo "$(pwd)" >> $GITHUB_PATH
                  echo "source $(pwd)/emsdk_env.sh" >> $GITHUB_ENV

            - name: Test Emscripten
              run: |
                  source emsdk/emsdk_env.sh
                  emcc -v

            # -------- Prepare output --------
            - name: Prepare web directory
              run: |
                  rm -rf web
                  mkdir -p web/cobrinha web/flappy web/quebra_bloco

            # -------- Build Cobrinha --------
            - name: Build Cobrinha (Web)
              run: |
                  source emsdk/emsdk_env.sh
                  cd Cobrinha
                  rm -rf build-web
                  mkdir build-web
                  emcmake cmake -S . -B build-web
                  cmake --build build-web
                  cp build-web/* ../web/cobrinha/

            # -------- Build Flappy --------
            - name: Build FlappyBirdRemix (Web)
              run: |
                  source emsdk/emsdk_env.sh
                  cd FlappyBirdRemix
                  rm -rf build-web
                  mkdir build-web
                  emcmake cmake -S . -B build-web
                  cmake --build build-web
                  cp build-web/* ../web/flappy/

            # -------- Build Quebra Bloco --------
            - name: Build Quebra Bloco (Web)
              run: |
                  source emsdk/emsdk_env.sh
                  cd Quebra_Bloco
                  rm -rf build-web
                  mkdir build-web
                  emcmake cmake -S . -B build-web
                  cmake --build build-web
                  cp build-web/* ../web/quebra_bloco/

            # -------- Deploy to gh-pages --------
            - name: Deploy to gh-pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_branch: gh-pages
                  publish_dir: ./web
                  force_orphan: true
